<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <title>é˜¿å¢¨å°å¸³æˆ¿</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/6418/6418336.png">
  <style>
    /* CSS è®Šæ•¸ç”± Vue å‹•æ…‹æ§åˆ¶ */
    :root {
      --primary: #7B6699;
      --secondary: #F3F0F5;
      --bg: #FDFDFF;
      --text: #4A4A4A;
      --highlight: #EAE3F2;
      --border: #E0D8E8;
      --income: #5D8C71;
      --expense: #BA5C5C;
    }

    body,
    input,
    button,
    select,
    textarea {
      font-family: 'Noto Serif TC', serif;
      -webkit-font-smoothing: antialiased;
      letter-spacing: 0.02em;
    }

    body {
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      color: var(--text);
      margin: 0;
      padding: 12px;
      padding-bottom: 100px;
    }

    .container {
      width: 100%;
      max-width: 1150px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    /* å¡ç‰‡å„ªåŒ–ï¼šæ¥µè‡´æ¯›ç»ç’ƒ Glassmorphism */
    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-top: 4px solid var(--primary);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease-out;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.12);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* é ç®—æ²¹é‡è¡¨ */
    .budget-box {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
      padding: 15px;
    }

    .progress-track {
      height: 10px;
      background: #E0E0E0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease, background-color 0.5s;
    }

    .summary-grid {
      display: flex;
      justify-content: space-around;
      text-align: center;
      gap: 10px;
    }

    .stat-val {
      font-size: 1.35rem;
      font-weight: 700;
      margin-top: 4px;
      letter-spacing: 0.05em;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .chart-scroll-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }

    .chart-container {
      position: relative;
      height: 260px;
      min-width: 300px;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }



    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-family: inherit;
      font-size: 0.95rem;
      outline: none;
      box-sizing: border-box;
      background: #FAFAFA;
      transition: 0.2s;
      color: var(--text);
      line-height: normal;
      height: 42px;
      /* ç¨å¾®ç¸®å°é«˜åº¦ï¼Œè®“æ’ç‰ˆæ›´ç²¾ç·» */
    }

    textarea {
      height: auto;
      /* å¤šè¡Œè¼¸å…¥æ¡†é«˜åº¦è‡ªå®š */
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      background: #FFF;
      box-shadow: 0 0 0 3px var(--secondary);
    }

    .search-highlight {
      background-color: var(--highlight);
      color: var(--primary);
      border-radius: 2px;
      padding: 0 2px;
      font-weight: bold;
    }

    .icon-btn {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #FFF;
      color: var(--primary);
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }

    .icon-btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    .icon-btn.active {
      background: var(--primary);
      color: #FFF;
      border-color: var(--primary);
    }

    .icon-btn.clear {
      color: #BBB;
      border: none;
      background: none;
    }

    .clear-select-btn {
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
      color: #CCC;
      cursor: pointer;
      z-index: 2;
      transition: color 0.2s;
    }

    .clear-select-btn:hover {
      color: var(--expense);
    }

    /* æ‰¹æ¬¡æ“ä½œå·¥å…·åˆ— */
    .batch-action-bar {
      display: flex;
      align-items: center;
      background: var(--primary);
      color: #FFF;
      padding: 10px 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      gap: 15px;
      animation: slideInDown 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .batch-info {
      font-weight: 600;
      flex: 1;
    }

    .batch-btns {
      display: flex;
      gap: 8px;
    }

    .batch-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: #FFF;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: 0.3s;
    }

    .batch-btn:hover {
      background: #FFF;
      color: var(--primary);
    }

    .batch-btn.danger:hover {
      background: #FF4D4D;
      color: #FFF;
      border-color: #FF4D4D;
    }

    /* Checkbox æ¨£å¼å„ªåŒ– */
    .custom-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .row-selected {
      background-color: var(--highlight) !important;
    }

    .mobile-checkbox-wrap {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 5;
    }

    .desktop-table-box {
      display: block;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #FFF;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
      table-layout: fixed;
    }

    th {
      background: var(--secondary);
      color: var(--primary);
      padding: 14px;
      text-align: left;
      font-size: 0.9rem;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      cursor: pointer;
    }

    td {
      padding: 14px;
      border-bottom: 1px solid #F2F2F2;
      font-size: 0.9rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .mobile-list-box {
      display: none;
    }

    .mobile-item-card {
      background: #FFF;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 15px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      border-left: 4px solid var(--primary);
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .mobile-item-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
    }

    .archive-tag {
      position: absolute;
      top: 0;
      right: 0;
      background: #F0F0F0;
      color: #999;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 0 12px 0 10px;
    }

    @media screen and (max-width: 768px) {
      .desktop-table-box {
        display: none !important;
      }

      .mobile-list-box {
        display: block !important;
        margin-top: 10px;
      }

      .summary-grid {
        flex-direction: row !important;
        justify-content: space-between !important;
        gap: 8px !important;
        padding: 18px 12px !important;
      }

      .stat-val {
        font-size: 1.1rem !important;
      }

      .filter-bar {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .search-input-wrap {
        grid-column: span 2;
      }

      .select-input-wrap {
        flex: none !important;
        width: 100%;
      }

      .control-btns {
        grid-column: span 1;
        margin-top: 0;
        justify-content: flex-end;
        height: 40px;
        /* èˆ‡ input å°é½Š */
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 20px 16px;
      }
    }

    .search-input-wrap {
      flex: 2 1 200px;
      min-width: 0;
    }

    .select-input-wrap {
      flex: 1 1 90px;
      min-width: 0;
      position: relative;
    }

    .control-btns {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .cat-badge {
      display: inline-flex;
      align-items: center;
      font-size: 0.75rem;
      background: var(--secondary);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    .fab {
      position: fixed;
      bottom: 30px;
      right: 25px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .fab:active {
      transform: scale(0.95);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1500;
      /* ä½æ–¼ Modal çš„ 2000ï¼Œé¿å…æ“‹ä½è¨­å®šè¦–çª— */
      backdrop-filter: blur(2px);
      pointer-events: none;
      /* å…è¨±ç©¿é€éå» */
      transition: opacity 0.3s;
      opacity: 0;
    }

    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .loading-overlay.active.blocking {
      background: rgba(255, 255, 255, 0.6);
      z-index: 9999;
    }

    .loader-mini {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.75rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translate(-50%, -20px);
        opacity: 0;
      }

      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    /* å…¸é›…è‰²ç³»é¸å–® */
    .theme-dropdown {
      position: absolute;
      top: 55px;
      right: 20px;
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
      display: grid;
      gap: 8px;
      z-index: 200;
      width: 140px;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #555;
      transition: 0.2s;
    }

    .theme-option:hover {
      background: var(--secondary);
      color: var(--primary);
    }

    .color-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-block;
      border: 2px solid white;
      box-shadow: 0 0 0 1px #ddd;
    }

    /* ğŸ¨ è‡ªè¨‚å°è©±æ¡†ç³»çµ± (å–ä»£ confirm/prompt) */
    .sys-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 3000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .sys-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      animation: scaleUp 0.2s ease-out;
    }

    .sys-modal-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: var(--primary);
    }

    .sys-modal-msg {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .sys-modal-input {
      margin-bottom: 20px;
    }

    .sys-modal-btns {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* .btn åŸºç¤æ¨£å¼ - è¦‹çµ±ä¸€æŒ‰éˆ•ç³»çµ±å€å¡Š */

    .btn-ghost {
      background: #f5f5f5;
      color: #666;
    }

    .btn-ghost:hover {
      background: #eee;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-danger {
      background: var(--expense);
      color: white;
    }

    /* ğŸ Toast é€šçŸ¥ */
    .toast-container {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      backdrop-filter: blur(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: toastIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.success {
      background: rgba(67, 160, 71, 0.9);
    }

    .toast.error {
      background: rgba(229, 57, 53, 0.9);
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /*  Modal å½ˆçª—ç³»çµ± */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal-window {
      background: white;
      border-radius: 24px;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.5);
      position: relative;
      animation: scaleUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      font-size: 1.2rem;
      color: #CCC;
      cursor: pointer;
      transition: 0.2s;
    }

    .close-btn:hover {
      color: var(--expense);
    }

    /* ç®¡ç†ä¸­å¿ƒå¼·åŒ–æ¨£å¼ */
    .tabs-nav {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      border-bottom: 2px solid #eee;
      flex-shrink: 0;
    }

    .tab-btn {
      padding: 12px 0;
      cursor: pointer;
      font-size: 0.95rem;
      color: #999;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      flex: 1;
      text-align: center;
      font-weight: 500;
      margin-bottom: -2px;
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: bold;
    }

    .setting-section-title {
      font-size: 0.85rem;
      font-weight: 800;
      color: var(--primary);
      margin: 20px 0 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-section-title:first-child {
      margin-top: 0;
    }

    .setting-card {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
    }

    .setting-group {
      margin-bottom: 18px;
    }

    .setting-group:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }

    .collapse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
      border-top: 1px solid #f0f0f0;
      margin-top: 10px;
    }

    .recur-item-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 15px;
      position: relative;
      transition: 0.3s;
    }

    .recur-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 10px;
    }

    @media screen and (max-width: 500px) {
      .recur-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    .recur-badge {
      font-size: 0.7rem;
      padding: 2px 10px;
      border-radius: 6px;
      background: var(--secondary);
      color: var(--primary);
      margin-right: 8px;
      font-weight: bold;
      white-space: nowrap;
      display: inline-block;
    }

    .qr-reply-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .qr-reply-row input {
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    .warning-text {
      color: #d32f2f;
      font-size: 0.7rem;
      margin-top: 4px;
      display: block;
    }

    /* çµ±ä¸€æŒ‰éˆ•ç³»çµ±ï¼šç´«è‰²å¯¦å¿ƒ vs ç´«åº•ç´«æ¡† */
    .btn {
      padding: 0 20px;
      height: 42px;
      /* èˆ‡è¼¸å…¥æ¡†é«˜åº¦åŒæ­¥ */
      border-radius: 12px;
      border: none !important;
      outline: none !important;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--primary) !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(123, 102, 153, 0.25);
      font-size: 0.95rem;
    }

    .btn.outline {
      background: var(--secondary) !important;
      border: 1.5px solid var(--primary) !important;
      color: var(--primary) !important;
      box-shadow: none;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1.5px);
      box-shadow: 0 6px 20px rgba(123, 102, 153, 0.35);
    }

    .btn.outline:hover {
      background: var(--highlight) !important;
      box-shadow: 0 4px 12px rgba(123, 102, 153, 0.15);
    }

    .btn:active {
      transform: scale(0.95);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleUp {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ğŸƒ ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #AAA;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
      color: var(--primary);
      display: block;
    }

    .empty-state p {
      margin: 5px 0;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <!-- åƒ…åœ¨æœ‰è³‡æ–™ä¸”éèƒŒæ™¯è¼‰å…¥æ™‚é¡¯ç¤ºå¾®å‹è®€å–ä¸­ -->
    <div v-if="isProcessing && activeData.length > 0 && !showModal && !showSettings" class="loader-mini">
      <i class="fas fa-circle-notch fa-spin"></i> åŒæ­¥ä¸­...
    </div>

    <!-- å…¨è¢å¹•è®€å–ï¼šåƒ…åœ¨é‡è¦æ“ä½œ (Modal é–‹å•Ÿæ™‚) æ‰é˜»æ“‹é»æ“Š -->
    <div v-if="isProcessing && showModal" class="loading-overlay" :class="{blocking: showModal}">
      <i class="fas fa-feather-alt fa-spin fa-2x" style="color:var(--primary);"></i>
    </div>

    <!-- ä¸€èˆ¬è¼‰å…¥ä¸­çš„ç¾½æ¯› (åˆæ¬¡è¼‰å…¥æ™‚é¡¯ç¤ºï¼Œä½†ä¸é˜»æ“‹é»æ“Š) -->
    <div v-if="isProcessing && activeData.length === 0" class="loading-overlay">
      <i class="fas fa-feather-alt fa-spin fa-2x" style="color:var(--primary);"></i>
    </div>

    <div class="card"
      style="display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; position: relative; z-index: 500;">
      <h2 style="margin:0; color:var(--primary); font-size: 1.2rem; letter-spacing: 0.05em;">
        <a :href="sheetUrl || '#'" target="_blank" style="color:inherit; text-decoration:none;">
          <i class="fas fa-book-open" title="é–‹å•Ÿå¾Œå°è©¦ç®—è¡¨"></i>
        </a>
        {{ appTitle }}
      </h2>
      <div style="display:flex; gap:12px; position:relative; z-index:501;">
        <button @click="showThemeMenu = !showThemeMenu" class="icon-btn" title="åˆ‡æ›è‰²ç³»"><i
            class="fas fa-palette"></i></button>
        <button @click="showSettings = true" class="icon-btn" title="é€£ç·šè¨­å®š"><i class="fas fa-cog"></i></button>
        <button @click="refreshActiveData" class="icon-btn" title="æ‰‹å‹•åŒæ­¥"><i class="fas fa-sync-alt"></i></button>
      </div>

      <div v-if="showThemeMenu" class="theme-dropdown" @mouseleave="showThemeMenu = false">
        <div v-for="(t, key) in themes" :key="key" class="theme-option" @click="setTheme(key)">
          <span class="color-dot" :style="{background: t.primary}"></span> {{ t.name }}
        </div>
      </div>
    </div>

    <div class="card summary-grid">
      <div class="stat-box">
        <div style="color:#888; font-size:0.8rem; margin-bottom:4px;">æ”¶å…¥</div>
        <div class="stat-val" style="color:var(--income);">{{ formatMoney(totalIncome || 0) }}</div>
      </div>
      <div class="stat-box">
        <div style="color:#888; font-size:0.8rem; margin-bottom:4px;">æ”¯å‡º</div>
        <div class="stat-val" style="color:var(--expense);">{{ formatMoney(totalExpense || 0) }}</div>
      </div>
      <div class="stat-box">
        <div style="color:#888; font-size:0.8rem; margin-bottom:4px;">çµé¤˜</div>
        <div class="stat-val" style="color:var(--primary);">{{ formatMoney(totalBalance || 0) }}</div>
      </div>
    </div>

    <!-- é ç®—æ²¹é‡è¡¨ (è‹¥æœ‰è¨­å®šæ‰é¡¯ç¤º) -->
    <!-- é ç®—æ²¹é‡è¡¨ (ç²¾ç°¡ç‰ˆ) -->
    <div class="card" v-if="monthlyBudget > 0" style="padding: 10px 24px; margin-bottom: 15px;">
      <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; color:#666;">
        <div>
          <span>ğŸ’° é ç®—ï¼š{{ formatMoney(monthlyBudget) }}</span>
          <i class="fas fa-pen" @click="openModal('budget')"
            style="margin-left:5px; cursor:pointer; color:var(--primary);"></i>
          <span style="color:#CCC; margin:0 5px;">|</span>
          <span :style="{color: budgetColor}">å‰©é¤˜ï¼š{{ formatMoney(monthlyBudget - currentMonthExpense) }}</span>
        </div>
        <div style="font-weight:bold; font-size:0.8rem;" :style="{color: budgetColor}">{{ Math.round(budgetPercent) }}%
        </div>
      </div>
      <div class="progress-track" style="height:6px; margin-top:6px; background:#F0F0F0;">
        <div class="progress-bar" :style="{width: Math.min(budgetPercent, 100) + '%', backgroundColor: budgetColor}">
        </div>
      </div>
    </div>

    <div class="chart-grid">
      <div class="card">
        <h3 style="font-size:0.9rem; text-align:center; color:var(--primary); margin:0 0 15px 0;">é¡åˆ¥åˆ†ä½ˆ</h3>
        <div class="chart-container"><canvas id="chartCat"></canvas></div>
      </div>
      <div class="card">
        <h3 style="font-size:0.9rem; text-align:center; color:var(--primary); margin:0 0 15px 0;">æ”¶æ”¯è¶¨å‹¢</h3>
        <div class="chart-scroll-wrapper">
          <div class="chart-container" :style="{ minWidth: trendChartWidth }"><canvas id="chartTrend"></canvas></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="filter-bar">
        <div class="search-input-wrap"><input type="text" v-model="filter.q" placeholder="ğŸ” æœå°‹é …ç›®..."></div>
        <div class="select-input-wrap" style="position:relative">
          <select v-model="filter.month" style="padding-right: 40px">
            <option value="">ğŸ“… æœˆä»½</option>
            <option value="custom">ğŸ“… è‡ªè¨‚å€é–“...</option>
            <option v-for="m in availableMonths" :value="m">{{ m }}</option>
            <option v-if="filter.customRange" :value="filter.customRange" disabled selected>{{ filter.customRangeText }}
            </option>
          </select>
          <i v-if="filter.month" @click="filter.month=''" class="fas fa-times-circle clear-select-btn" title="æ¸…é™¤æœˆä»½"></i>
        </div>
        <div class="select-input-wrap" style="position:relative">
          <select v-model="filter.cat" style="padding-right: 40px">
            <option value="">ğŸ·ï¸ é¡åˆ¥</option>
            <optgroup label="æ”¯å‡º">
              <option v-for="c in groupedCats.expense" :value="c">{{ c }}</option>
            </optgroup>
            <optgroup label="æ”¶å…¥">
              <option v-for="c in groupedCats.income" :value="c">{{ c }}</option>
            </optgroup>
          </select>
          <i v-if="filter.cat" @click="filter.cat=''" class="fas fa-times-circle clear-select-btn" title="æ¸…é™¤é¡åˆ¥"></i>
        </div>
        <div class="select-input-wrap" style="position:relative">
          <select v-model="filter.type" style="padding-right: 40px">
            <option value="">ğŸ”„ å…¨éƒ¨</option>
            <option value="æ”¯å‡º">â– æ”¯å‡º</option>
            <option value="æ”¶å…¥">â• æ”¶å…¥</option>
          </select>
          <i v-if="filter.type" @click="filter.type=''" class="fas fa-times-circle clear-select-btn" title="æ¸…é™¤ç¯©é¸"></i>
        </div>

        <div class="control-btns">
          <div @click="toggleArchive" class="icon-btn" :class="{active: useArchive}" title="æ­·å²åº«">
            <i class="fas fa-history"></i>
          </div>
          <div @click="sortDesc = !sortDesc" class="icon-btn" :title="sortDesc ? 'å€’åº' : 'é †åº'">
            <i :class="sortDesc ? 'fas fa-sort-amount-down' : 'fas fa-sort-amount-up-alt'"></i>
          </div>
          <div @click="batchMode = !batchMode" class="icon-btn" :class="{active: batchMode}" title="æ‰¹æ¬¡æ¨¡å¼">
            <i class="fas fa-tasks"></i>
          </div>
          <div v-if="hasActiveFilter" @click="resetFilters" class="icon-btn clear" title="é‡è¨­å…¨éƒ¨">
            <i class="fas fa-times-circle fa-lg"></i>
          </div>
        </div>
      </div>

      <!-- æ‰¹æ¬¡æ“ä½œåˆ— -->
      <div v-if="selectedRows.length > 0" class="batch-action-bar">
        <div class="batch-info">å·²é¸å– {{ selectedRows.length }} ç­†è³‡æ–™</div>
        <div class="batch-btns">
          <button @click="batchChangeCat" class="batch-btn"><i class="fas fa-tags"></i> æ›´æ”¹åˆ†é¡</button>
          <button @click="batchDelete" class="batch-btn danger"><i class="fas fa-trash-alt"></i> æ‰¹æ¬¡åˆªé™¤</button>
          <button @click="selectedRows = []" class="batch-btn" style="opacity:0.8"><i class="fas fa-times"></i>
            å–æ¶ˆ</button>
        </div>
      </div>

      <div class="desktop-table-box">
        <div v-if="displayItems.length === 0" class="empty-state">
          <i class="fas fa-wind"></i>
          <p>é€™è£¡ç©ºç©ºå¦‚ä¹Ÿ...</p>
          <p style="font-size:0.8rem">è©¦è‘—è¨˜ä¸€ç­†ï¼Œæˆ–æ¸…é™¤ç¯©é¸æ¢ä»¶çœ‹çœ‹ï¼Ÿ</p>
        </div>
        <table v-else>
          <thead>
            <tr>
              <th v-if="batchMode" style="width:40px; text-align:center;">
                <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll" class="custom-checkbox">
              </th>
              <th style="width:120px" @click="sortBy('date')">æ—¥æœŸ <i :class="getSortIcon('date')"></i></th>
              <th style="width:110px">é¡åˆ¥</th>
              <th>é …ç›®æ˜ç´°</th>
              <th style="width:130px; text-align:right;" @click="sortBy('amount')">é‡‘é¡ <i
                  :class="getSortIcon('amount')"></i></th>
              <th style="width:100px; text-align:center;">
                æ“ä½œ <i class="fas fa-tasks" @click="batchMode = !batchMode"
                  style="cursor:pointer; font-size:0.8rem; margin-left:4px;"
                  :style="{color: batchMode ? 'var(--primary)' : '#ccc'}" title="é–‹é—œæ‰¹æ¬¡é¸å–"></i>
              </th>
            </tr>
          </thead>
          <tbody v-if="isProcessing && filteredItems.length === 0">
            <tr v-for="n in 5" :key="'skel-row-'+n">
              <td>
                <div class="skeleton skeleton-text" style="width:80%"></div>
              </td>
              <td>
                <div class="skeleton skeleton-text" style="width:60%"></div>
              </td>
              <td>
                <div class="skeleton skeleton-text" style="width:90%"></div>
                <div class="skeleton skeleton-text" style="width:40%; height:0.7rem"></div>
              </td>
              <td>
                <div class="skeleton skeleton-text" style="width:70%; margin-left:auto;"></div>
              </td>
              <td>
                <div class="skeleton skeleton-circle" style="margin: 0 auto"></div>
              </td>
            </tr>
          </tbody>
          <tbody v-else>
            <tr v-for="i in displayItems" :key="i.sheet+i.row" :class="{ 'row-selected': isSelected(i) }">
              <td v-if="batchMode" style="text-align:center;">
                <input type="checkbox" :value="i" v-model="selectedRows" class="custom-checkbox">
              </td>
              <td style="color:#888;">{{ i.date }} <span v-if="i.sheet==='Archive'"
                  style="font-size:0.6rem; color:#CCC;">[èˆŠ]</span></td>
              <td>
                <span class="cat-badge">
                  <span style="font-size:0.9em; margin-right:4px;">{{ getIcon(i.category) }}</span>{{ i.category }}
                </span>
              </td>
              <td>
                <div v-html="highlight(i.item)" style="font-weight:600; color:#333;"></div>
                <div v-html="highlight(i.note)" style="color:#999; font-size:0.8rem; margin-top:4px;"></div>
              </td>
              <td :style="{color: i.type==='æ”¶å…¥'?'var(--income)':'var(--expense)', fontWeight:'600', textAlign:'right'}">
                {{ formatMoney(i.amount) }}</td>
              <td style="text-align:center;">
                <button @click="openModal('edit', i)"
                  style="color:#C4A484; border:none; background:none; cursor:pointer; padding:6px;"><i
                    class="fas fa-edit"></i></button>
                <button @click="deleteRow(i)"
                  style="color:#D8A3A3; border:none; background:none; cursor:pointer; padding:6px; margin-left:6px;"><i
                    class="fas fa-trash-alt"></i></button>
              </td>
            </tr>
            <tr v-if="displayItems.length > 0" style="background:var(--secondary); font-weight:bold;">
              <td colspan="3" style="text-align:right; font-size:0.85rem; color:#777;">ç•¶å‰é¡¯ç¤º ({{ displayItems.length }} /
                {{ filteredItems.length }} ç­†)</td>
              <td style="text-align:right; color:var(--primary)">{{ formatMoney(totalBalance || 0) }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="mobile-list-box">
        <div v-if="displayItems.length === 0" class="empty-state">
          <i class="fas fa-wind"></i>
          <p>ä¸€ç‰‡å¯§éœ...</p>
          <p style="font-size:0.8rem">æ²’æœ‰ç¬¦åˆçš„å¸³ç›®</p>
        </div>
        <div v-else v-for="i in displayItems" :key="'mob-'+i.sheet+i.row" class="mobile-item-card"
          :class="{ 'row-selected': isSelected(i) }">
          <div v-if="batchMode" class="mobile-checkbox-wrap">
            <input type="checkbox" :value="i" v-model="selectedRows" class="custom-checkbox">
          </div>
          <div v-if="i.sheet==='Archive'" class="archive-tag">æ­·å²</div>
          <div class="mobile-row-top" style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span style="color:#888; font-size:0.9rem;">{{ i.date }}</span>
            <span>
              <span class="cat-badge">
                <span style="font-size:0.9em; margin-right:2px;">{{ getIcon(i.category) }}</span>{{ i.category }}
              </span>
            </span>
          </div>
          <div style="margin-bottom:12px;">
            <div v-html="highlight(i.item)" style="font-weight:600; font-size:1.05rem; color:#333;"></div>
            <div v-html="highlight(i.note)" style="color:#999; font-size:0.85rem; margin-top:4px;"></div>
          </div>
          <div
            style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #F5F5F5; padding-top:10px;">
            <div :style="{color: i.type==='æ”¶å…¥'?'var(--income)':'var(--expense)', fontWeight:'bold', fontSize:'1.1rem'}">
              {{ i.type === 'æ”¶å…¥' ? '+' : '-' }}{{ formatMoney(i.amount) }}</div>
            <div>
              <button @click="openModal('edit', i)" style="color:#C4A484; border:none; background:none; padding:8px;"><i
                  class="fas fa-edit"></i></button>
              <button @click="deleteRow(i)" style="color:#D8A3A3; border:none; background:none; padding:8px;"><i
                  class="fas fa-trash-alt"></i></button>
            </div>
          </div>
        </div>
        <div v-if="hasMoreItems" style="text-align:center; padding:20px; color:#999;">
          <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ›´å¤š...
        </div>
        <div class="subtotal-panel" v-if="displayItems.length > 0"
          style="text-align:center; padding:10px; color:var(--primary); font-weight:bold; background:var(--secondary); border-radius:8px;">
          å°è¨ˆï¼š{{ formatMoney(totalBalance || 0) }}</div>
      </div>
    </div>

    <div class="fab" @click="openModal('add')"><i class="fas fa-plus"></i></div>

    <!-- ğŸ–Šï¸ ä¸»ç·¨è¼¯ Modal -->
    <div class="modal-overlay" v-if="showModal" @click.self="showModal=false">
      <div class="modal-window">
        <div class="modal-header">
          <div class="modal-title">{{ modalTitle }}</div>
          <i class="fas fa-times close-btn" @click="showModal = false"></i>
        </div>

        <!-- è‡ªè¨‚å€é–“æ¨¡å¼ -->
        <div v-if="modalMode==='range'">
          <div style="margin-bottom: 12px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">é–‹å§‹æ—¥æœŸ</label>
            <input type="date" v-model="rangeForm.start">
          </div>
          <div style="margin-bottom: 25px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">çµæŸæ—¥æœŸ</label>
            <input type="date" v-model="rangeForm.end">
          </div>
        </div>

        <!-- è¨­å®šé ç®—æ¨¡å¼ -->
        <div v-if="modalMode==='budget'">
          <div style="margin-bottom: 25px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">æ¯æœˆé ç®—é‡‘é¡</label>
            <input type="number" v-model="form.amount" placeholder="è¼¸å…¥é ç®—é‡‘é¡">
          </div>
        </div>

        <!-- æ—¢æœ‰çš„ç·¨è¼¯æ¨¡å¼ -->
        <div v-else-if="modalMode==='add' || modalMode==='edit'">
          <div style="display: flex; gap: 12px; margin-bottom: 15px;">
            <div style="flex:1;"><label
                style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">æ—¥æœŸ</label><input type="date"
                v-model="form.date"></div>
            <div style="flex:1;"><label
                style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">æ”¶æ”¯</label><select
                v-model="form.type">
                <option>æ”¯å‡º</option>
                <option>æ”¶å…¥</option>
              </select></div>
          </div>
          <div style="margin-bottom: 12px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">é¡åˆ¥</label>
            <select v-model="form.category">
              <option disabled value="">è«‹é¸æ“‡é¡åˆ¥</option>
              <option v-for="c in modalCatOptions" :value="c">{{ c }}</option>
            </select>
          </div>
          <div style="margin-bottom: 12px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">é …ç›®</label><input type="text"
              v-model="form.item" placeholder="å¦‚ï¼šåˆé¤"></div>
          <div style="margin-bottom: 12px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">é‡‘é¡</label><input type="number"
              v-model="form.amount" placeholder="0"></div>
          <div style="margin-bottom: 25px;"><label
              style="font-size:0.8rem; color:#999; margin-bottom:4px; display:block;">å‚™è¨»</label><input type="text"
              v-model="form.note" placeholder="å‚™è¨»äº‹é …..."></div>
        </div>

        <div style="text-align:center; display:flex; gap:12px; margin-top:20px;">
          <button class="btn outline" style="flex:1;"
            @click="showModal=false; if(modalMode==='range' && !filter.customRange) filter.month='';">å–æ¶ˆ</button>
          <button class="btn" style="flex:2;" @click="submitForm">ç¢ºèªå®Œæˆ</button>
        </div>
      </div>
    </div>
    <!-- Toast å®¹å™¨ (åƒ…å­˜æ”¾é€šçŸ¥) -->
    <div class="toast-container">
      <div v-for="(t, idx) in toasts" :key="idx" class="toast" :class="t.type">
        <i v-if="t.type==='success'" class="fas fa-check-circle"></i>
        <i v-if="t.type==='error'" class="fas fa-exclamation-circle"></i>
        {{ t.msg }}
      </div>
    </div>

    <!-- é€£ç·šè¨­å®š Modal -->
    <div class="modal-overlay" v-if="showSettings" @click.self="showSettings = false">
      <div class="modal-window"
        style="max-width: 680px; max-height: 90vh; display:flex; flex-direction:column; padding:30px; background: rgba(255,255,255,0.9); border:none;">
        <div class="modal-header" style="margin-bottom:15px; flex-shrink:0;">
          <div class="modal-title" style="font-size:1.3rem;"><i class="fas fa-sliders-h"></i> ç³»çµ±ç®¡ç†ä¸­å¿ƒ</div>
          <i class="fas fa-times close-btn" @click="showSettings = false" style="font-size:1.2rem;"></i>
        </div>

        <div class="tabs-nav">
          <div class="tab-btn" :class="{active: settingsTab === 'general'}" @click="settingsTab='general'">åŸºç¤é€£ç·š</div>
          <div class="tab-btn" :class="{active: settingsTab === 'ai'}" @click="settingsTab='ai'">å€‹äººåå¥½</div>
          <div class="tab-btn" :class="{active: settingsTab === 'recur'}" @click="settingsTab='recur'">é€±æœŸæ”¶æ”¯</div>
        </div>

        <div style="flex:1; overflow-y:auto; padding-right:10px;" class="custom-scrollbar">
          <!-- åŸºç¤é€£ç·š Tab -->
          <div v-if="settingsTab === 'general'">
            <div class="setting-section-title"><i class="fas fa-link"></i> API èˆ‡é€£ç·šè¨­å®š</div>
            <div class="setting-card">
              <div class="setting-group" style="margin-bottom: 0;">
                <label class="setting-label">GAS Web App URL (é—œéµ)</label>
                <div style="display:flex; gap:8px;">
                  <input type="password" v-model="tempGasUrl" placeholder="è«‹å¡«å…¥ .gs éƒ¨ç½²å¾Œçš„ç¶²å€"
                    style="background:#fff; flex:1;">
                  <button @click="initSystem" class="btn outline"
                    style="width:auto; padding:0 15px; white-space:nowrap;">
                    <i class="fas fa-magic"></i> åˆå§‹åŒ–
                  </button>
                </div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div class="setting-group">
                  <label class="setting-label">Gemini API Key</label>
                  <input type="password" v-model="fullConfig.GEMINI_API_KEY" placeholder="Gemini é‡‘é‘°">
                </div>
                <div class="setting-group">
                  <label class="setting-label">LINE Push Token</label>
                  <input type="password" v-model="fullConfig.LINE_ACCESS_TOKEN" placeholder="Line Access Token">
                </div>
              </div>
            </div>

            <div class="setting-section-title"><i class="fas fa-share-alt"></i> å…±äº«è¨­å®š</div>
            <div class="setting-card">
              <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">ç”¢ç”Ÿå¸¶æœ‰ç›®å‰é€£ç·šè³‡è¨Šçš„åŠ å¯†é€£çµï¼Œè®“å…¶ä»–æ‰‹æ©Ÿä¹Ÿèƒ½ä¸€æƒå³ç”¨ã€‚</p>
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div style="flex:1;">
                  <button @click="generateShareLink" class="btn"
                    style="width:100%; margin-bottom:12px; border-radius:12px;">
                    <i class="fas fa-qrcode"></i> ç”¢ç”Ÿåˆ†äº«é€£çµèˆ‡ QR Code
                  </button>
                  <div v-if="shareUrl" style="display:flex; gap:8px; animation: fadeIn 0.3s;">
                    <input type="text" :value="shortUrl || shareUrl" readonly
                      style="flex:1; background:#f9f9f9; font-size:0.8rem; border-radius:12px;">
                    <button @click="copyToClipboard(shortUrl || shareUrl)" class="btn outline"
                      style="padding:0 20px; flex-shrink:0; border-radius:12px;">è¤‡è£½é€£çµ</button>
                  </div>
                </div>
                <div v-if="shareUrl" style="text-align:center; animation: fadeIn 0.3s;">
                  <img :src="'https://quickchart.io/qr?text=' + encodeURIComponent(shareUrl)"
                    style="width:92px; border:4px solid white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                </div>
              </div>
            </div>

            <div class="collapse-header" @click="showAdvModel = !showAdvModel">
              <span><i class="fas fa-cog"></i> é€²éšæ¨¡å‹è¨­å®š</span>
              <i class="fas" :class="showAdvModel ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <div v-if="showAdvModel" class="setting-card" style="margin-top:10px; padding:15px;">
              <label class="setting-label">Gemini æ¨¡å‹ ID</label>
              <input type="text" v-model="fullConfig.GEMINI_MODEL" placeholder="ä¾‹å¦‚: gemini-2.0-flash"
                style="border-radius:12px;">
            </div>
          </div>

          <!-- å€‹äººåå¥½ Tab -->
          <div v-if="settingsTab === 'ai'">
            <div class="setting-section-title"><i class="fas fa-user-edit"></i> å¸³æœ¬å¤–è§€èˆ‡é ç®—</div>
            <div class="setting-card">
              <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
                <div class="setting-group">
                  <label class="setting-label">å¸³æœ¬è‡ªè¨‚æ¨™é¡Œ</label>
                  <input type="text" v-model="fullConfig.APP_TITLE" style="border-radius:12px;">
                </div>
                <div class="setting-group">
                  <label class="setting-label">æ¯æœˆé ç®—ä¸Šé™</label>
                  <input type="number" v-model.number="fullConfig.MONTHLY_BUDGET" style="border-radius:12px;">
                </div>
              </div>
            </div>

            <div class="setting-section-title"><i class="fas fa-robot"></i> AI åŠ©ç†è¨­å®š</div>
            <div class="setting-card">
              <div class="setting-group">
                <label class="setting-label">AI è§’è‰²/èªæ°£æè¿°</label>
                <textarea v-model="fullConfig.ROLE_SETTING" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½å¹½é»˜ä½†å°é‡‘éŒ¢å¾ˆç²¾æ˜çš„ç®¡å®¶..."
                  style="border-radius:12px; padding: 10px 15px;"></textarea>
              </div>
              <div class="setting-group">
                <label class="setting-label">ç‰¹æ®Šè¨˜å¸³/æ—¥ç¨‹è¦å‰‡</label>
                <textarea v-model="fullConfig.SPECIAL_RULES" placeholder="è¦å®š AI é‡åˆ°ç‰¹å®šæ–‡å­—æ™‚çš„è™•ç†æ–¹å¼..."
                  style="border-radius:12px; padding: 10px 15px;"></textarea>
              </div>
            </div>

            <div class="setting-section-title"><i class="fas fa-list-ul"></i> LINE å¿«é€Ÿå›è¦†é¸å–®</div>
            <div class="setting-card">
              <div v-for="(qr, qidx) in quickReplyList" :key="qidx" class="qr-reply-row">
                <input type="text" v-model="qr.label" placeholder="æŒ‰éˆ•é¡¯ç¤º" style="flex:1;">
                <input type="text" v-model="qr.text" placeholder="å‚³é€å…§å®¹" style="flex:2;">
                <i class="fas fa-times" @click="quickReplyList.splice(qidx,1)"
                  style="color:#ccc; cursor:pointer; padding:5px;"></i>
              </div>
              <button @click="addQuickReply" class="btn outline" style="width:100%; margin-top:10px;">
                <i class="fas fa-plus"></i> æ–°å¢å¿«é€Ÿå›è¦†æŒ‰éˆ•
              </button>
            </div>
          </div>

          <!-- é€±æœŸæ”¶æ”¯ Tab -->
          <div v-if="settingsTab === 'recur'">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <div class="setting-section-title" style="margin:0;"><i class="fas fa-history"></i> å®šæœŸè¦å‰‡ç®¡ç† ({{
                recurData.length }})</div>
              <button @click="addRecurItem" class="btn outline" style="padding:8px 20px; font-size:0.85rem;">
                <i class="fas fa-plus"></i> æ–°å¢è¦å‰‡
              </button>
            </div>

            <div v-for="(item, idx) in recurData" :key="idx" class="recur-item-card" :class="{disabled: !item.å•Ÿç”¨}">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div style="font-weight:bold; display:flex; align-items:center; flex:1;">
                  <span class="recur-badge">{{ item.é »ç‡ }}</span>
                  <input type="text" v-model="item.é …ç›®"
                    style="border:none; padding:4px 8px; font-weight:bold; background:none; width:100%;">
                </div>
                <div style="display:flex; gap:18px; align-items:center;">
                  <i :class="item.å•Ÿç”¨ ? 'fas fa-toggle-on' : 'fas fa-toggle-off'" @click="item.å•Ÿç”¨ = !item.å•Ÿç”¨"
                    :title="item.å•Ÿç”¨ ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'"
                    :style="{ color: item.å•Ÿç”¨ ? 'var(--primary)' : '#ccc', fontSize: '1.6rem', cursor: 'pointer', transition: '0.2s' }"></i>
                  <i class="fas fa-trash-alt" @click="removeRecurItem(idx)"
                    style="color:#ff6b6b; cursor:pointer; opacity:0.6; font-size:1.1rem;"></i>
                </div>
              </div>
              <div class="recur-grid">
                <div>
                  <label class="setting-label">é »ç‡</label>
                  <select v-model="item.é »ç‡" style="height:42px; padding: 0 15px; border-radius:12px;">
                    <option value="æ¯æœˆ">æ¯æœˆ</option>
                    <option value="æ¯é€±">æ¯é€±</option>
                    <option value="æ¯å¹´">æ¯å¹´</option>
                    <option value="æ¯å¤©">æ¯å¤©</option>
                  </select>
                </div>
                <div>
                  <label class="setting-label">æ—¥æœŸ / é€±å¹¾</label>
                  <input type="text" v-model="item.æ—¥æœŸ" placeholder="ä¾‹: 1 æˆ– é€±ä¸€" style="border-radius:12px;">
                </div>
                <div>
                  <label class="setting-label">é‡‘é¡</label>
                  <input type="number" v-model.number="item.é‡‘é¡" style="border-radius:12px;">
                </div>
                <div>
                  <label class="setting-label">é¡åˆ¥</label>
                  <input type="text" v-model="item.é¡åˆ¥" placeholder="ä¾‹: é¤é£²" style="border-radius:12px;">
                </div>
              </div>
              <div style="margin-top:15px;">
                <label class="setting-label">å‚™è¨»èªªæ˜</label>
                <input type="text" v-model="item.å‚™è¨»" placeholder="è¼¸å…¥å‚™è¨»..." style="border-radius:12px;">
              </div>
            </div>
          </div> <!-- end recur tab -->
        </div> <!-- end scroll container -->

        <div
          style="flex-shrink:0; margin-top:25px; display:flex; justify-content:center; border-top:1px solid #f0f0f0; padding-top:25px;">
          <button class="btn" style="width: 100%; max-width: 300px; font-size:1.1rem; font-weight:bold;"
            @click="saveFullConfig">
            <span v-if="isProcessing"><i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...</span>
            <span v-else>ç¢ºèªä¸¦åŒæ­¥é›²ç«¯</span>
          </button>
        </div>
      </div> <!-- Closes modal-window -->
    </div> <!-- Closes modal-overlay -->

    <!-- ğŸ¨ è‡ªè¨‚å°è©±æ¡†ç³»çµ± HTML -->
    <div v-if="sysModal.show" class="sys-modal-overlay">
      <div class="sys-modal">
        <div class="sys-modal-title">{{ sysModal.title }}</div>
        <div class="sys-modal-msg" v-html="sysModal.msg"></div>
        <div v-if="sysModal.type === 'prompt'" class="sys-modal-input">
          <input v-model="sysModal.inputValue" :placeholder="sysModal.placeholder" ref="sysInput">
        </div>
        <div class="sys-modal-btns">
          <button @click="sysModal.onCancel" class="btn btn-ghost">{{ sysModal.cancelText }}</button>
          <button @click="sysModal.onConfirm" :class="['btn', sysModal.isDanger ? 'btn-danger' : 'btn-primary']">
            {{ sysModal.confirmText }}
          </button>
        </div>
      </div>
    </div>

  </div> <!-- end app -->

  <script>
    const DEFAULT_GAS_URL = "";

    // å®‰å…¨å–å¾—åˆå§‹è³‡æ–™ï¼Œé¿å…åœ¨æœ¬åœ°é è¦½æ™‚å™´éŒ¯
    const initialDataFromServer = typeof preloadedData !== 'undefined' ? preloadedData : [];
    const initialBudget = typeof monthlyBudget !== 'undefined' ? monthlyBudget : 0;
    const initialAppTitle = typeof appTitle !== 'undefined' ? appTitle : 'é˜¿å¢¨å°å¸³æˆ¿';
    document.title = initialAppTitle; // åˆå§‹åŒ–æ¨™é¡Œ

    const { createApp, ref, reactive, computed, watch, onMounted, onBeforeUnmount, nextTick, toRefs } = Vue;

    createApp({
      setup() {
        const state = reactive({
          gasUrl: '', tempGasUrl: '', shareUrl: '', shortUrl: '', sheetUrl: '',
          activeData: initialDataFromServer, archiveData: [], useArchive: false, isProcessing: false,
          recurData: [], monthlyBudget: initialBudget, appTitle: initialAppTitle,
          filter: { q: '', month: new Date().toISOString().slice(0, 7), cat: '', type: '', customRange: null, customRangeText: '' },
          debouncedQuery: '', // æ–°å¢ï¼šé˜²æŠ–æœå°‹å­—ä¸²
          sortKey: 'date', sortDesc: true, showModal: false, modalMode: 'add', showThemeMenu: false, currentThemeKey: 'default',
          showSettings: false, settingsTab: 'general', showAdvModel: false, fullConfig: {}, quickReplyList: [], configCats: null,
          displayLimit: 30, form: { date: '', type: 'æ”¯å‡º', category: '', item: '', amount: '', note: '', row: null, sheet: 'å·¥ä½œè¡¨1' },
          rangeForm: { start: '', end: '' }, charts: { cat: null, trend: null }, toasts: [], iconCache: {}, selectedRows: [], batchMode: false,
          sysModal: { show: false, title: '', msg: '', type: 'confirm', inputValue: '', placeholder: '', confirmText: 'ç¢ºå®š', cancelText: 'å–æ¶ˆ', isDanger: false, onConfirm: null, onCancel: null }
        });

        // ã€å…¸é›…é…è‰²ç³»çµ±ã€‘
        const themes = {
          default: {
            name: 'ç´«ç…™å¢¨éŸ»',
            primary: '#7B6699', secondary: '#F3F0F5', highlight: '#EAE3F2', border: '#E0D8E8', income: '#5D8C71', expense: '#BA5C5C',
            chartInc: '#A8D8B9', chartExp: '#E0A3AD'
          },
          forest: {
            name: 'ç«¹æ—é›…è‡´',
            primary: '#536D58', secondary: '#F1F5F2', highlight: '#DDE6DE', border: '#D3DBD4', income: '#4A7050', expense: '#B5655D',
            chartInc: '#9EBC9F', chartExp: '#C79893'
          },
          ocean: {
            name: 'æ»„æµ·æœˆæ˜',
            primary: '#5C7A96', secondary: '#F0F4F8', highlight: '#DCE6F0', border: '#D1DEE8', income: '#4A80A8', expense: '#BD6B6B',
            chartInc: '#99B9D6', chartExp: '#D6999E'
          },
          pink: {
            name: 'æ¡ƒå¤­ç¼è¯',
            primary: '#B57E8C', secondary: '#FAF2F4', highlight: '#F4DEE4', border: '#EBD4DB', income: '#6E9C91', expense: '#C95C72',
            chartInc: '#93B5A9', chartExp: '#E6B8C2'
          }
        };

        // ======= ğŸ¨ [Composable] è‡ªè¨‚å°è©±æ¡†ç³»çµ± =======
        const useSystemModal = () => {
          const sysConfirm = (msg, title = 'ç¢ºèªæ“ä½œ', isDanger = false) => {
            return new Promise((resolve) => {
              state.sysModal = {
                show: true, title, msg, type: 'confirm', isDanger,
                confirmText: 'ç¢ºå®š', cancelText: 'å–æ¶ˆ',
                onConfirm: () => { state.sysModal.show = false; resolve(true); },
                onCancel: () => { state.sysModal.show = false; resolve(false); }
              };
            });
          };

          const sysPrompt = (msg, title = 'è¼¸å…¥è³‡æ–™', defaultValue = '', placeholder = '') => {
            return new Promise((resolve) => {
              state.sysModal = {
                show: true, title, msg, type: 'prompt', inputValue: defaultValue, placeholder,
                confirmText: 'æäº¤', cancelText: 'å–æ¶ˆ',
                onConfirm: () => {
                  const val = state.sysModal.inputValue;
                  state.sysModal.show = false;
                  resolve(val);
                },
                onCancel: () => { state.sysModal.show = false; resolve(null); }
              };
            });
          };

          return { sysConfirm, sysPrompt };
        };
        const { sysConfirm, sysPrompt } = useSystemModal();

        // ======= ğŸŒ [Composable] API é€šè¨Šç³»çµ± =======
        const useApi = () => {
          const apiCall = async (method, params, success, failure) => {
            if (state.gasUrl && !window.google?.script?.run) {
              try {
                const url = new URL(state.gasUrl);
                const isGet = ['getData', 'getCategoryConfig', 'fetchActiveData', 'fetchArchiveData'].includes(method);
                if (isGet) {
                  url.searchParams.append('action', method);
                  url.searchParams.append('_t', Date.now()); // é˜²æ­¢ç€è¦½å™¨å¿«å– (Cache Buster)
                }
                const options = { method: isGet ? 'GET' : 'POST', redirect: 'follow', mode: 'cors' };
                if (!isGet) {
                  options.body = JSON.stringify({ action: method, params: params || [] });
                  options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
                }
                const resp = await fetch(url.toString(), options);
                if (!resp.ok) throw new Error('HTTP Status ' + resp.status);
                const res = await resp.json();
                if (success) success(res);
              } catch (e) {
                console.error('API Error:', e);
                if (failure) failure(e); else showToast('é€£ç·šå¤±æ•—: ' + e.message, 'error');
              }
            } else if (window.google?.script?.run) {
              let r = google.script.run;
              if (success) r = r.withSuccessHandler(success);
              if (failure) r = r.withFailureHandler(failure);
              r[method](...(params || []));
            } else {
              if (method !== 'getData') { state.showSettings = true; showToast('è«‹å…ˆè¨­å®šé€£çµç¶²å€', 'error'); }
              if (failure) failure('No URL');
            }
          };

          const initGasUrl = () => {
            const p = new URLSearchParams(window.location.search);
            const c = p.get('config');
            if (c) {
              try {
                const d = atob(c);
                localStorage.setItem('ahmo_gas_url', d);
                state.gasUrl = d;
                window.history.replaceState({}, document.title, window.location.pathname);
              } catch (ex) { }
            } else {
              state.gasUrl = localStorage.getItem('ahmo_gas_url') || DEFAULT_GAS_URL;
            }
            state.tempGasUrl = state.gasUrl;
          };

          return { apiCall, initGasUrl };
        };
        const { apiCall, initGasUrl } = useApi();

        // ======= ğŸ [Composable] UI èˆ‡é€šçŸ¥ç³»çµ± =======
        const useUi = () => {
          const showToast = (msg, type = 'success') => {
            const t = { msg, type }; state.toasts.push(t);
            setTimeout(() => { state.toasts.shift(); }, 3000);
          };
          const setTheme = (themeKey) => {
            const t = themes[themeKey]; if (!t) return;
            state.currentThemeKey = themeKey;
            const root = document.documentElement;
            const props = { '--primary': t.primary, '--secondary': t.secondary, '--highlight': t.highlight, '--border': t.border, '--income': t.income, '--expense': t.expense };
            Object.entries(props).forEach(([k, v]) => root.style.setProperty(k, v));
            localStorage.setItem('ahmo_theme', themeKey); state.showThemeMenu = false;
            nextTick(() => { if (typeof renderCharts === 'function') renderCharts(); });
          };
          const formatMoney = (v) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(v);
          const highlightText = (text) => {
            if (!text || !state.debouncedQuery.trim()) return text;
            const regex = new RegExp(`(${state.debouncedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
          };
          const getIcon = (cat) => {
            if (!cat) return 'ğŸ·ï¸'; if (state.iconCache[cat]) return state.iconCache[cat];
            const c = String(cat);
            const rules = [{ r: /è–ª|å·¥è³‡|é…¬/, i: 'ğŸ’°' }, { r: /ç|ç´…åŒ…|ç¦®é‡‘/, i: 'ğŸ§§' }, { r: /æŠ•|è³‡|è‚¡|åŒ¯|åˆ©æ¯/, i: 'ğŸ“ˆ' }, { r: /å›é¥‹|é€€|æŠ˜|è£œè²¼/, i: 'ğŸ’¸' }, { r: /è‚²å…’|å¬°|ç«¥|å¯¶|å°¿å¸ƒ|å¥¶/, i: 'ğŸ‘¶' }, { r: /æ|ä½›|å»Ÿ|ç¥|å¥‰|ç»|å…¬å¾·/, i: 'ğŸ™' }, { r: /æ—…|å®¿|é£›|æ©Ÿç¥¨|éŠ/, i: 'âœˆï¸' }, { r: /é†«|è—¥|ç—…|è¨º|ç‰™|å¥/, i: 'ğŸ¥' }, { r: /è´ˆ|ç¦®|é€|å®¢/, i: 'ğŸ' }, { r: /å­¸|æ›¸|èª²|è£œ|è®€|æ•™/, i: 'ğŸ“–' }, { r: /è¨‚é–±|æœƒå“¡|æœˆè²»/, i: 'ğŸ’³' }, { r: /é£Ÿ|é¤|é£²|åƒ|å–|é…’|åˆ|æ™š|æ—©/, i: 'ğŸš' }, { r: /è¡£|æœ|é‹|åŒ…|é£¾|å¦/, i: 'ğŸ‘š' }, { r: /ä½|æˆ¿|æ°´|é›»|æ°£|ç¶²|ç§Ÿ/, i: 'ğŸ ' }, { r: /è¡Œ|è»Š|æ²¹|é‹|ç¥¨|äº¤é€š|æ·|éµ/, i: 'ğŸš—' }, { r: /æ¨‚|ç©|å½±|éŸ³|å”±|æˆ²|ä¼‘é–’/, i: 'ğŸ®' }, { r: /è³¼|è²·|æ—¥ç”¨|è²¨|å•†|è¶…å•†/, i: 'ğŸ›ï¸' }, { r: /ç¨…|è²»|è½‰å¸³|åŒ¯/, i: 'ğŸ“„' }];
            const found = rules.find(r => c.match(r.r)); state.iconCache[cat] = found ? found.i : 'âœ¨';
            return state.iconCache[cat];
          };
          return { showToast, setTheme, formatMoney, highlightText, getIcon };
        };
        const { showToast, setTheme, formatMoney, highlightText, getIcon } = useUi();

        // ======= ğŸ“Š [Composable] åœ–è¡¨æ¸²æŸ“ç³»çµ± =======
        const useCharts = () => {
          const renderCharts = () => {
            if (state._chartDebounce) clearTimeout(state._chartDebounce);
            state._chartDebounce = setTimeout(() => {
              nextTick(() => {
                const ctxCat = document.getElementById('chartCat'), ctxTrend = document.getElementById('chartTrend');
                if (!ctxCat || !ctxTrend || items.value.length === 0) return;
                const typeToShow = state.filter.type === 'æ”¶å…¥' ? 'æ”¶å…¥' : 'æ”¯å‡º';
                const t = themes[state.currentThemeKey];
                const catMap = {}; filteredItems.value.filter(i => i.type === typeToShow).forEach(i => { catMap[i.category] = (catMap[i.category] || 0) + i.amount; });
                if (state.charts.cat) state.charts.cat.destroy();
                state.charts.cat = new Chart(ctxCat, { type: 'doughnut', data: { labels: Object.keys(catMap), datasets: [{ data: Object.values(catMap), backgroundColor: typeToShow === 'æ”¶å…¥' ? [t.chartInc, '#81C784', '#A5D6A7'] : [t.primary, '#9FA8DA', '#B39DDB'] }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => { if (el.length > 0) state.filter.cat = state.charts.cat.data.labels[el[0].index]; }, plugins: { legend: { position: 'bottom' } } } });
                const months = [...new Set(items.value.map(i => i.date.slice(0, 7)))].sort();
                // O(n) é è¨ˆç®—æœˆä»½æ”¶æ”¯ Map
                const monthIncMap = {}, monthExpMap = {};
                items.value.forEach(i => {
                  const m = i.date.slice(0, 7);
                  if (i.type === 'æ”¶å…¥') monthIncMap[m] = (monthIncMap[m] || 0) + i.amount;
                  else if (i.type === 'æ”¯å‡º') monthExpMap[m] = (monthExpMap[m] || 0) + i.amount;
                });
                if (state.charts.trend) state.charts.trend.destroy();
                state.charts.trend = new Chart(ctxTrend, { type: 'bar', data: { labels: months.map(m => m.split('-')[1] + 'æœˆ'), datasets: [{ label: 'æ”¶å…¥', data: months.map(m => monthIncMap[m] || 0), backgroundColor: t.chartInc }, { label: 'æ”¯å‡º', data: months.map(m => monthExpMap[m] || 0), backgroundColor: t.chartExp }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => { if (el.length > 0) { state.filter.month = months[el[0].index]; state.filter.type = el[0].datasetIndex === 0 ? 'æ”¶å…¥' : 'æ”¯å‡º'; } else { const pt = state.charts.trend.getElementsAtEventForMode(e, 'index', { intersect: false }, true); if (pt.length > 0) { state.filter.month = months[pt[0].index]; state.filter.type = ''; } } } } });
              });
            }, 300);
          };
          return { renderCharts };
        };
        const { renderCharts } = useCharts();

        // ======= ğŸ’° [Composable] å¸³å‹™æ ¸å¿ƒé‚è¼¯ =======
        const useTransactions = () => {
          const openModal = (mode, item = null) => {
            state.modalMode = mode;
            if (mode === 'add') state.form = { date: new Date().toISOString().slice(0, 10), type: 'æ”¯å‡º', category: '', item: '', amount: '', note: '', row: null, sheet: 'å·¥ä½œè¡¨1' };
            else if (mode === 'edit') Object.assign(state.form, item);
            else if (mode === 'range') state.rangeForm = { start: new Date().toISOString().slice(0, 10), end: new Date().toISOString().slice(0, 10) };
            else if (mode === 'budget') state.form.amount = state.monthlyBudget;
            state.showModal = true;
          };
          const submitForm = () => {
            if (state.modalMode === 'range') {
              if (state.rangeForm.start > state.rangeForm.end) { showToast('æ—¥æœŸå€é–“éŒ¯èª¤', 'error'); return; }
              state.filter.customRange = { start: state.rangeForm.start, end: state.rangeForm.end }; state.filter.customRangeText = `${state.rangeForm.start.slice(5)}~${state.rangeForm.end.slice(5)}`;
              state.filter.month = state.filter.customRange; state.showModal = false; return;
            }
            if (state.modalMode === 'budget') {
              const nb = Number(state.form.amount); if (!nb || nb < 0) { showToast('é‡‘é¡ç„¡æ•ˆ', 'error'); return; }
              state.isProcessing = true; apiCall('updateBudget', [nb], () => { state.isProcessing = false; state.monthlyBudget = nb; showToast('æ¨™é ç®—å·²æ›´æ–°'); state.showModal = false; });
              return;
            }
            state.isProcessing = true;
            const data = [state.form.date, state.form.type, state.form.category, state.form.item, state.form.amount, state.form.note];
            const done = (res) => {
              // ä¼ºæœå™¨åŒæ­¥æˆåŠŸå¾Œå†æ¬¡æ ¡æº–ï¼Œç¢ºä¿åºè™Ÿ(row)æ­£ç¢º
              if (Array.isArray(res)) state.activeData = res;
              else refreshActiveData(true);
              state.showModal = false;
              showToast('æ›´æ–°æˆåŠŸ');
            };

            if (state.modalMode === 'add') {
              // æœ¬åœ°å…ˆè¡Œæ¸²æŸ“ (Optimistic UI)
              const newItem = [state.form.date, state.form.type, state.form.category, state.form.item, Number(state.form.amount), state.form.note, 9999, SHEETS.MAIN];
              state.activeData.unshift(newItem);
              apiCall('addData', [data], done, () => { state.isProcessing = false; refreshActiveData(true); });
            } else {
              const idx = state.activeData.findIndex(r => r[6] == state.form.row && r[7] == state.form.sheet);
              if (idx !== -1) {
                const updatedRow = [...data, state.form.row, state.form.sheet];
                state.activeData.splice(idx, 1, updatedRow);
              }
              apiCall('updateData', [state.form.row, data, state.form.sheet], done, () => { state.isProcessing = false; refreshActiveData(true); });
            }
          };
          const deleteRow = async (item) => {
            if (await sysConfirm('ç¢ºå®šåˆªé™¤æ­¤ç­†å¸³ç›®ï¼Ÿ', 'åˆªé™¤ç¢ºèª', true)) {
              state.isProcessing = true;
              // æœ¬åœ°åˆªé™¤ (Optimistic UI)
              state.activeData = state.activeData.filter(r => !(r[6] == item.row && r[7] == item.sheet));
              apiCall('deleteData', [item.row, item.sheet], () => {
                showToast('å·²åˆªé™¤');
                state.isProcessing = false;
                state.selectedRows = state.selectedRows.filter(r => r.row !== item.row || r.sheet !== item.sheet);
              }, () => { state.isProcessing = false; refreshActiveData(true); });
            }
          };
          const batchDelete = async () => {
            if (state.selectedRows.length === 0) return;
            if (await sysConfirm(`ç¢ºå®šæ‰¹æ¬¡åˆªé™¤ ${state.selectedRows.length} ç­†é …ç›®ï¼Ÿ`, 'æ‰¹æ¬¡åˆªé™¤', true)) {
              state.isProcessing = true; apiCall('batchDeleteData', [state.selectedRows.map(r => ({ row: r.row, sheet: r.sheet }))], () => { refreshActiveData(); state.selectedRows = []; showToast('å·²æ‰¹æ¬¡åˆªé™¤'); }, () => state.isProcessing = false);
            }
          };
          const batchChangeCat = async () => {
            if (state.selectedRows.length === 0) return;
            const newCat = await sysPrompt("è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š", "æ‰¹æ¬¡ä¿®æ”¹åˆ†é¡");
            if (newCat && newCat.trim()) {
              state.isProcessing = true; apiCall('batchUpdateCategory', [state.selectedRows.map(r => ({ row: r.row, sheet: r.sheet })), newCat.trim()], () => { refreshActiveData(); state.selectedRows = []; showToast('å·²æ‰¹æ¬¡æ›´æ–°'); }, () => state.isProcessing = false);
            }
          };
          const refreshActiveData = (bg = false) => {
            if (!bg) state.isProcessing = true;
            apiCall('fetchActiveData', null, res => {
              if (res && res.error) { if (!bg) showToast(res.error, 'error'); state.isProcessing = false; return; }
              state.activeData = res;
              preprocessData(); // æ‰‹å‹•è§¸ç™¼é è™•ç†ï¼Œç¢ºä¿ UI å³æ™‚æ›´æ–°
              state.isProcessing = false;
              localStorage.setItem('ahmo_cache', JSON.stringify(res));
              renderCharts();
              if (!bg) showToast('è³‡æ–™å·²åŒæ­¥');
            }, () => state.isProcessing = false);
          };
          const toggleArchive = () => {
            state.useArchive = !state.useArchive;
            if (state.useArchive && state.archiveData.length === 0) {
              state.isProcessing = true; apiCall('fetchArchiveData', null, res => { state.archiveData = res; state.isProcessing = false; renderCharts(); }, () => state.isProcessing = false);
            }
          };
          return { openModal, submitForm, deleteRow, batchDelete, batchChangeCat, refreshActiveData, toggleArchive };
        };
        const { openModal, submitForm, deleteRow, batchDelete, batchChangeCat, refreshActiveData, toggleArchive } = useTransactions();

        const infiniteScroll = () => {
          if (state._scrollLocked) return; state._scrollLocked = true;
          requestAnimationFrame(() => { if (document.documentElement.scrollTop + window.innerHeight >= document.documentElement.offsetHeight - 200 && hasMoreItems.value) { state.displayLimit += 50; } state._scrollLocked = false; });
        };
        const sortBy = (k) => { if (state.sortKey === k) state.sortDesc = !state.sortDesc; else { state.sortKey = k; state.sortDesc = true; } };
        const getSortIcon = (k) => state.sortKey !== k ? 'fas fa-sort' : (state.sortDesc ? 'fas fa-sort-down' : 'fas fa-sort-up');
        const isSelected = (item) => selectedSet.value.has(item.row + '|' + item.sheet);
        const toggleSelectAll = () => { state.selectedRows = isAllSelected.value ? [] : [...displayItems.value]; };
        const saveFullConfig = () => {
          if (!state.tempGasUrl.trim()) { showToast('GAS ç¶²å€ä¸å¯ç‚ºç©º', 'error'); return; }
          state.isProcessing = true; localStorage.setItem('ahmo_gas_url', state.tempGasUrl.trim()); state.gasUrl = state.tempGasUrl.trim();
          state.fullConfig.LINE_QUICK_REPLY = state.quickReplyList.filter(i => i.label.trim()).map(i => `${i.label.trim()}:${(i.text || i.label).trim()}`).join('|');
          const recur = state.recurData.map(r => ({ ...r, é …ç›®: r.é …ç›® || 'æœªå‘½åé …ç›®', å•Ÿç”¨: r.å•Ÿç”¨ ? 'TRUE' : 'FALSE' }));
          apiCall('saveAllSettings', [{ config: state.fullConfig, recur }], () => { localStorage.removeItem('ahmo_cache'); showToast('é›²ç«¯è¨­å®šå·²åŒæ­¥'); location.reload(); }, () => state.isProcessing = false);
        };
        const clearSettings = async () => { if (await sysConfirm('å°‡æ¸…é™¤æœ¬åœ°å„²å­˜çš„é€£ç·šç¶²å€ï¼Œç¢ºå®šå—ï¼Ÿ', 'æ¸…é™¤è¨­å®š', true)) { localStorage.removeItem('ahmo_cache'); localStorage.removeItem('ahmo_gas_url'); location.reload(); } };
        const initSystem = async () => { if (await sysConfirm('å°‡è‡ªå‹•å»ºç«‹å¿…è¦å·¥ä½œè¡¨èˆ‡è¨­å®šè‡ªå‹•æ’ç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ', 'ç³»çµ±åˆå§‹åŒ–')) { state.isProcessing = true; apiCall('runSystemInit', [], res => { state.isProcessing = false; showToast(res || 'åˆå§‹åŒ–å®Œæˆ'); }); } };
        const generateShareLink = async () => {
          if (!state.gasUrl) { showToast('è«‹å…ˆå„²å­˜ GAS ç¶²å€', 'error'); return; }
          state.shareUrl = `${window.location.origin}${window.location.pathname}?config=${btoa(state.gasUrl)}`;
          try {
            const fd = new FormData(); fd.append('url', state.shareUrl);
            const r = await fetch('https://cleanuri.com/api/v1/shorten', { method: 'POST', body: fd });
            const res = await r.json(); if (res.result_url) state.shortUrl = res.result_url;
          } catch (e) { }
          showToast("åˆ†äº«é€£çµå·²ç”¢ç”Ÿ");
        };
        const copyToClipboard = (t) => { navigator.clipboard.writeText(t).then(() => showToast('å·²è¤‡è£½')); };
        const addQuickReply = () => { state.quickReplyList.push({ label: '', text: '' }); };
        const addRecurItem = () => {
          state.recurData.unshift({
            é »ç‡: 'æ¯æœˆ', æ—¥æœŸ: '1', é …ç›®: 'æ–°è¦å‰‡', é‡‘é¡: 0, é¡åˆ¥: '', å‚™è¨»: '', å•Ÿç”¨: true
          });
        };
        const removeRecurItem = async (idx) => { if (await sysConfirm('ç¢ºå®šç§»é™¤æ­¤é€±æœŸè¦å‰‡ï¼Ÿ', 'ç§»é™¤ç¢ºèª', true)) state.recurData.splice(idx, 1); };;
        const openSheet = () => window.open(state.sheetUrl || '#', '_blank');
        const resetFilters = () => { state.filter = { q: '', month: new Date().toISOString().slice(0, 7), cat: '', type: '', customRange: null, customRangeText: '' }; };


        const allData = computed(() => state.useArchive ? [...state.activeData, ...state.archiveData] : state.activeData);
        // å„ªåŒ–ï¼šé è™•ç†è³‡æ–™ï¼Œé¿å… computed æ¯æ¬¡ map
        const items = computed(() => {
          return (allData.value || []).map(r => ({
            date: r[0],
            type: r[1],
            category: r[2],
            item: r[3],
            amount: Number(String(r[4] || 0).replace(/,/g, '')),
            note: r[5],
            row: r[6],
            sheet: r[7]
          }));
        });

        const filteredItems = computed(() => {
          let inc = 0, exp = 0;
          let res = items.value.filter(i => {
            const qm = (i.item + i.note).toLowerCase().includes(state.debouncedQuery.toLowerCase());
            let mm = state.filter.customRange ? (i.date >= state.filter.customRange.start && i.date <= state.filter.customRange.end) : (state.filter.month ? i.date.startsWith(state.filter.month) : true);
            const pass = qm && mm && (!state.filter.cat || i.category === state.filter.cat) && (!state.filter.type || i.type === state.filter.type);
            if (pass) { if (i.type === 'æ”¶å…¥') inc += i.amount; else if (i.type === 'æ”¯å‡º') exp += i.amount; }
            return pass;
          });
          state._filteredIncome = inc;
          state._filteredExpense = exp;
          return res.sort((a, b) => { let m = state.sortDesc ? -1 : 1; return a[state.sortKey] !== b[state.sortKey] ? (a[state.sortKey] > b[state.sortKey] ? m : -m) : (a.row - b.row) * m; });
        });
        const displayItems = computed(() => filteredItems.value.slice(0, state.displayLimit));
        const selectedSet = computed(() => {
          const s = new Set();
          state.selectedRows.forEach(r => s.add(r.row + '|' + r.sheet));
          return s;
        });
        const isAllSelected = computed(() => displayItems.value.length > 0 && state.selectedRows.length === displayItems.value.length);
        const modalTitle = computed(() => state.modalMode === 'range' ? 'ğŸ“… è¨­å®šæŸ¥è©¢æœŸé–“' : (state.modalMode === 'budget' ? 'ğŸ’° è¨­å®šæ¯æœˆé ç®—' : (state.modalMode === 'add' ? 'ğŸ–Šï¸ è¨˜ä¸€ç­†' : 'ğŸ“ ä¿®æ”¹å¸³å‹™')));
        const modalCatOptions = computed(() => { if (!state.configCats) return []; const raw = state.form.type === 'æ”¶å…¥' ? state.configCats.income : state.configCats.expense; return raw ? raw.split(',').map(c => c.trim()) : []; });
        const availableMonths = computed(() => [...new Set(items.value.map(i => i.date.slice(0, 7)))].sort().reverse());
        const availableCats = computed(() => [...new Set(items.value.map(i => i.category))]);
        const groupedCats = computed(() => {
          const u = { expense: new Set(), income: new Set() }; items.value.forEach(i => { if (i.category) { if (i.type === 'æ”¶å…¥') u.income.add(i.category); else u.expense.add(i.category); } });
          const s = (set, str) => { const l = str ? str.split(',').map(c => c.trim()) : []; const r = []; l.forEach(c => { if (set.has(c)) r.push(c); }); return [...r, ...[...set].filter(c => !r.includes(c)).sort()]; };
          return { expense: s(u.expense, state.configCats?.expense), income: s(u.income, state.configCats?.income) };
        });
        const hasActiveFilter = computed(() => state.filter.q !== '' || state.filter.cat !== '' || state.filter.type !== '' || state.filter.month !== new Date().toISOString().slice(0, 7));
        const trendChartWidth = computed(() => {
          const count = availableMonths.value.length;
          return count > 8 ? (count * 50) + 'px' : '100%';
        });
        const hasMoreItems = computed(() => state.displayLimit < filteredItems.value.length);
        const totalIncome = computed(() => { filteredItems.value; return state._filteredIncome || 0; });
        const totalExpense = computed(() => { filteredItems.value; return state._filteredExpense || 0; });
        const totalBalance = computed(() => totalIncome.value - totalExpense.value);
        const currentMonthStr = ref(new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'));
        const curExp = computed(() => items.value.filter(i => i.date.startsWith(currentMonthStr.value) && i.type === 'æ”¯å‡º').reduce((a, b) => a + b.amount, 0));
        const budgetPercent = computed(() => state.monthlyBudget > 0 ? (curExp.value / state.monthlyBudget) * 100 : 0);
        const budgetColor = computed(() => budgetPercent.value < 50 ? 'var(--income)' : (budgetPercent.value < 80 ? '#E0BE89' : 'var(--expense)'));

        watch(() => state.filter, (n) => { if (n.month === 'custom') { openModal('range'); return; } if (typeof n.month === 'string' && n.month !== 'custom' && state.filter.customRange) { state.filter.customRange = null; state.filter.customRangeText = ''; } state.displayLimit = 30; state.selectedRows = []; renderCharts(); }, { deep: true });
        watch(() => state.displayLimit, () => { state.selectedRows = []; });
        watch(() => state.activeData, () => { renderCharts(); });
        watch(() => state.archiveData, () => { renderCharts(); });
        watch(() => state.appTitle, (n) => { document.title = n; });
        watch(() => state.batchMode, (n) => { if (!n) state.selectedRows = []; });

        watch(() => state.filter.q, (newVal) => {
          if (state._debounceTimer) clearTimeout(state._debounceTimer);
          state._debounceTimer = setTimeout(() => { state.debouncedQuery = newVal; state.displayLimit = 30; }, 300);
        });

        onMounted(() => {
          window.addEventListener('scroll', infiniteScroll); initGasUrl(); setTheme(localStorage.getItem('ahmo_theme') || 'default');
          state.isProcessing = true; apiCall('getData', null, res => {
            state.isProcessing = false; if (!res) return;
            if (res.config) {
              state.fullConfig = res.config; state.configCats = res.categories || { expense: res.config.EXPENSE_CATS, income: res.config.INCOME_CATS };
              if (res.config.APP_TITLE) state.appTitle = res.config.APP_TITLE; if (res.config.MONTHLY_BUDGET) state.monthlyBudget = Number(res.config.MONTHLY_BUDGET);
              state.quickReplyList = res.config.LINE_QUICK_REPLY ? res.config.LINE_QUICK_REPLY.split(/[|\n]/).map(p => { const x = p.split(/[:ï¼š]/); return { label: x[0]?.trim() || '', text: x[1]?.trim() || '' }; }).filter(i => i.label) : [];
            }
            if (res.activeData) { state.activeData = res.activeData; localStorage.setItem('ahmo_cache', JSON.stringify(res.activeData)); }
            if (res.archiveData) state.archiveData = res.archiveData;
            if (res.recurData) state.recurData = res.recurData.map(r => ({ ...r, å•Ÿç”¨: [true, 'TRUE', 1].includes(r.å•Ÿç”¨) }));
            if (res.sheetUrl) state.sheetUrl = res.sheetUrl; nextTick(() => renderCharts());
          }, () => { state.isProcessing = false; const c = localStorage.getItem('ahmo_cache'); if (c) state.activeData = JSON.parse(c); if (!state.gasUrl) state.showSettings = true; renderCharts(); });
        });
        onBeforeUnmount(() => {
          window.removeEventListener('scroll', infiniteScroll);
          if (state._debounceTimer) clearTimeout(state._debounceTimer);
          if (state._chartDebounce) clearTimeout(state._chartDebounce);
        });

        return {
          ...toRefs(state), modalTitle, modalCatOptions, allData, items, filteredItems, displayItems, isAllSelected,
          availableMonths, availableCats, groupedCats, hasActiveFilter, trendChartWidth, hasMoreItems,
          totalIncome, totalExpense, totalBalance, currentMonthExpense: curExp, budgetPercent, budgetColor,
          showToast, setTheme, apiCall, initGasUrl, saveFullConfig, initSystem, addQuickReply, clearSettings,
          addRecurItem, removeRecurItem, generateShareLink, copyToClipboard, toggleArchive, refreshActiveData,
          resetFilters, formatMoney, highlight: highlightText, sortBy, getSortIcon, getIcon, openModal, submitForm, themes,
          deleteRow, isSelected, toggleSelectAll, infiniteScroll, renderCharts, openSheet
        };
      }
    }).mount('#app');
  </script>
</body>

</html>